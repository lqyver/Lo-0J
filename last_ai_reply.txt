----- main.py -----
a, b = 3, 4
c = a & b
d = a ^ b
e = (a & (~b)) + (b & (~a))
print(e)
----- run_and_fix.py -----
#!/usr/bin/env python3
import json, re, subprocess, requests, sys
from pathlib import Path

# ========== ç”¨æˆ·åªæ”¹è¿™é‡Œ ==========
ENTRY_FILE = Path("C:/Users/leo/Desktop/za/work/2025/mini mini/ai/2.0/main.py")
SOURCE_DIR = Path("C:/Users/leo/Desktop/za/work/2025/mini mini/ai/2.0")

REQ_FILE = Path("requirements.md")
MODEL = "qwen2.5-coder:7b"
OLLAMA_URL = "http://localhost:11434/api/chat"
MAX_ROUND = 5

def read(f: Path) -> str: return f.read_text(encoding="utf8")
def write(f: Path, s: str): f.write_text(s, encoding="utf8")

req = read(REQ_FILE) if REQ_FILE.exists() else ""

# â‘  åŠ è½½æ•´æ£µæºç æ ‘ï¼ˆç›¸å¯¹è·¯å¾„ â†’ å†…å®¹ï¼‰
code_tree = {str(p.relative_to(SOURCE_DIR)): read(p)
             for p in SOURCE_DIR.rglob("*.py")}

# â‘¡ è¿è¡Œå…¥å£æ–‡ä»¶
def run():
    r = subprocess.run([sys.executable, str(ENTRY_FILE)],
                       capture_output=True, text=True, cwd=SOURCE_DIR.parent)
    return r.returncode == 0, r.stdout + r.stderr

# â‘¢ AI éœ€æ±‚æ ¡éªŒ
def check_output(stdout: str):
    sys_msg = (
        "ä½ æ˜¯éœ€æ±‚æ£€æŸ¥å®˜ã€‚è¯·ä¸¥æ ¼å¯¹ç…§ç”¨æˆ·éœ€æ±‚æ£€æŸ¥ä¸‹åˆ—ä¸¤é¡¹ï¼š"
        "1) è¾“å‡ºç»“æœæ­£ç¡®ï¼›2) å®ç°è¿‡ç¨‹å®Œå…¨ç¬¦åˆéœ€æ±‚ï¼ˆå¦‚ç¦ç”¨+ã€ä½¿ç”¨ä½è¿ç®—ç­‰ï¼‰ã€‚"
        "å…ˆç®€è¦åˆ†æï¼Œæœ€åä¸€è¡Œåªå†™ True æˆ– Falseï¼Œä¸è¦å†™ä»£ç ã€‚"
    )
    user = (
        f"ç”¨æˆ·éœ€æ±‚ï¼š\\n{req}\\n\\n"
        f"å½“å‰æºç ï¼š\\n{json.dumps(code_tree, ensure_ascii=False)}\\n\\n"
        f"å®é™…è¾“å‡ºï¼š\\n{stdout}"
    )
    payload = {"model": MODEL, "messages": [
        {"role": "system", "content": sys_msg},
        {"role": "user", "content": user}
    ], "stream": False}
    resp = requests.post(OLLAMA_URL, json=payload, timeout=60).json()["message"]["content"].strip()
    # å–æœ€åä¸€è¡Œ True/False
    last_line = resp.splitlines()[-1].strip()
    if last_line == "True":
        return True, ""
    return False, resp

# â‘£ åˆå¹¶åˆ¤æ–­ï¼šå¼‚å¸¸ OR éœ€æ±‚ä¸ç¬¦ â†’ éƒ½ç®—å¤±è´¥
def run_and_check():
    ok, log = run()
    if not ok:
        return False, log                       # æœ‰å¼‚å¸¸
    fine, reason = check_output(log)          # log å³ stdout
    if not fine:
        return False, f"è¾“å‡ºä¸ç¬¦åˆéœ€æ±‚ï¼š{reason}\\n---- å®é™…è¾“å‡º ----\\n{log}"
    return True, log

# â‘¤ AI ä¿®å¤æ•´æ ‘
def fix(log: str):
    sys_msg = (
        "ä½ æ˜¯èµ„æ·± Python å¼€å‘ï¼Œå¿…é¡»åŒæ—¶æ»¡è¶³ï¼š"
        "1) ç”¨æˆ·éœ€æ±‚ï¼›2) è¿è¡Œæ— å¼‚å¸¸ä¸”è¾“å‡ºæ­£ç¡®ã€‚"
        "ç¦æ­¢è§£é‡Šï¼Œç›´æ¥è¿”å›å®Œæ•´æ–‡ä»¶å†…å®¹ï¼Œæ ¼å¼ï¼š\\n"
        "----- ç›¸å¯¹è·¯å¾„/æ–‡ä»¶å -----\\n<ä»£ç >"
    )
    user = f"éœ€æ±‚ï¼š\\n{req}\\n\\nè¿è¡Œæ—¥å¿—ï¼š\\n{log}\\n\\næºç æ ‘ï¼š\\n{json.dumps(code_tree, ensure_ascii=False)}"
    payload = {"model": MODEL, "messages": [
        {"role": "system", "content": sys_msg},
        {"role": "user", "content": user}
    ], "stream": False}
    out = requests.post(OLLAMA_URL, json=payload, timeout=300).json()["message"]["content"]

    # â‘  å…ˆç•™ç—•ï¼Œæ–¹ä¾¿è°ƒè¯•
    Path("last_ai_reply.txt").write_text(out, encoding="utf8")

    # â‘¡ å®‰å…¨è§£æ
    for name in re.findall(r"----- (\S+) -----", out):
        m = re.search(rf"----- {name} -----\\s+(.*?)\\s+(?=-----|$)", out, re.S)
        if not m:
            print(f"âš ï¸ æœªæå–åˆ° {name} çš„ä»£ç å—")
            continue
        code = m.group(1)
        target = SOURCE_DIR / name
        target.parent.mkdir(parents=True, exist_ok=True)
        write(target, code)
        print("ğŸ“ è¦†ç›– â†’", target)

    # â‘¢ åˆ·æ–°å†…å­˜
    code_tree.update({str(p.relative_to(SOURCE_DIR)): read(p)
                      for p in SOURCE_DIR.rglob("*.py")})

# â‘¥ ä¸»å¾ªç¯
def main():
    for i in range(1, MAX_ROUND + 1):
        print(f"\n===== ç¬¬ {i} æ¬¡è¿è¡Œ =====")
        ok, log = run_and_check()
        print(log)
        if ok:
            print("âœ… è¿è¡ŒæˆåŠŸä¸”ç¬¦åˆéœ€æ±‚")
            break
        print("âŒ å¤±è´¥ï¼Œæ­£åœ¨ä¿®å¤...")
        fix(log)
    else:
        print("âš ï¸ å·²è¾¾æœ€å¤§è¿­ä»£ï¼Œè¯·æ£€æŸ¥éœ€æ±‚æˆ–æ—¥å¿—")

if __name__ == "__main__":
    main()